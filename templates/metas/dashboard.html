{% extends "base.html" %}

{% block title %}Dashboard de Metas - {{ config.CLINIC_NAME }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Dashboard de Metas</h1>
        <p class="text-muted">Acompanhe o desempenho em relação às metas estabelecidas</p>
    </div>
    <div>
        <a href="{{ url_for('metas.configurar_metas') }}" class="btn btn-primary">
            <i class="fas fa-cog"></i> Configurar Metas
        </a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('metas.dashboard_metas') }}" class="row g-3">
            <div class="col-md-4">
                <label for="mes" class="form-label">Mês</label>
                <select class="form-select" id="mes" name="mes" onchange="this.form.submit()">
                    <option value="1" {% if mes_filtro == 1 %}selected{% endif %}>Janeiro</option>
                    <option value="2" {% if mes_filtro == 2 %}selected{% endif %}>Fevereiro</option>
                    <option value="3" {% if mes_filtro == 3 %}selected{% endif %}>Março</option>
                    <option value="4" {% if mes_filtro == 4 %}selected{% endif %}>Abril</option>
                    <option value="5" {% if mes_filtro == 5 %}selected{% endif %}>Maio</option>
                    <option value="6" {% if mes_filtro == 6 %}selected{% endif %}>Junho</option>
                    <option value="7" {% if mes_filtro == 7 %}selected{% endif %}>Julho</option>
                    <option value="8" {% if mes_filtro == 8 %}selected{% endif %}>Agosto</option>
                    <option value="9" {% if mes_filtro == 9 %}selected{% endif %}>Setembro</option>
                    <option value="10" {% if mes_filtro == 10 %}selected{% endif %}>Outubro</option>
                    <option value="11" {% if mes_filtro == 11 %}selected{% endif %}>Novembro</option>
                    <option value="12" {% if mes_filtro == 12 %}selected{% endif %}>Dezembro</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="ano" class="form-label">Ano</label>
                <select class="form-select" id="ano" name="ano" onchange="this.form.submit()">
                    <option value="2024" {% if ano_filtro == 2024 %}selected{% endif %}>2024</option>
                    <option value="2025" {% if ano_filtro == 2025 %}selected{% endif %}>2025</option>
                    <option value="2026" {% if ano_filtro == 2026 %}selected{% endif %}>2026</option>
                </select>
            </div>
        </form>
    </div>
</div>

{% if not meta %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i>
    Nenhuma meta configurada para este período.
    <a href="{{ url_for('metas.configurar_metas') }}" class="alert-link">Configurar agora</a>
</div>
{% else %}

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center border-success">
            <div class="card-body">
                <h6 class="text-muted mb-2">
                    <i class="fas fa-dollar-sign"></i> Faturamento
                </h6>
                <h2 class="text-success mb-1">{{ "%.0f"|format(perc_faturamento) }}%</h2>
                <p class="mb-1">
                    <strong>R$ {{ "%.2f"|format(faturamento_realizado) }}</strong>
                    de R$ {{ "%.2f"|format(meta.meta_faturamento) }}
                </p>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-success"
                         style="width: {{ perc_faturamento if perc_faturamento <= 100 else 100 }}%">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-center border-info">
            <div class="card-body">
                <h6 class="text-muted mb-2">
                    <i class="fas fa-user-check"></i> Atendimentos
                </h6>
                <h2 class="text-info mb-1">{{ "%.0f"|format(perc_atendimentos) }}%</h2>
                <p class="mb-1">
                    <strong>{{ atendimentos_realizados }}</strong>
                    de {{ meta.meta_atendimentos }}
                </p>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-info"
                         style="width: {{ perc_atendimentos if perc_atendimentos <= 100 else 100 }}%">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h6 class="text-muted mb-2">
                    <i class="fas fa-user-plus"></i> Novos Clientes
                </h6>
                <h2 class="text-warning mb-1">{{ "%.0f"|format(perc_novos_clientes) }}%</h2>
                <p class="mb-1">
                    <strong>{{ novos_clientes }}</strong>
                    de {{ meta.meta_novos_clientes }}
                </p>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-warning"
                         style="width: {{ perc_novos_clientes if perc_novos_clientes <= 100 else 100 }}%">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-line text-success"></i>
                    Histórico de Faturamento
                </h5>
                <canvas id="chartFaturamento" height="150"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-bar text-info"></i>
                    Histórico de Atendimentos
                </h5>
                <canvas id="chartAtendimentos" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title">
            <i class="fas fa-table text-primary"></i>
            Resumo dos Últimos 6 Meses
        </h5>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Período</th>
                        <th>Faturamento Meta</th>
                        <th>Faturamento Real</th>
                        <th>% Fat.</th>
                        <th>Atendimentos Meta</th>
                        <th>Atendimentos Real</th>
                        <th>% Atend.</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in historico %}
                    <tr>
                        <td><strong>{{ item.mes_nome }}/{{ item.ano }}</strong></td>
                        <td>R$ {{ "%.2f"|format(item.meta_faturamento) }}</td>
                        <td>R$ {{ "%.2f"|format(item.faturamento_realizado) }}</td>
                        <td>
                            {% if item.meta_faturamento > 0 %}
                            {% set perc = (item.faturamento_realizado / item.meta_faturamento) * 100 %}
                            <span class="badge {% if perc >= 100 %}bg-success{% elif perc >= 80 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ "%.0f"|format(perc) }}%
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">N/A</span>
                            {% endif %}
                        </td>
                        <td>{{ item.meta_atendimentos }}</td>
                        <td>{{ item.atendimentos_realizados }}</td>
                        <td>
                            {% if item.meta_atendimentos > 0 %}
                            {% set perc = (item.atendimentos_realizados / item.meta_atendimentos) * 100 %}
                            <span class="badge {% if perc >= 100 %}bg-success{% elif perc >= 80 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ "%.0f"|format(perc) }}%
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    {% if meta and historico %}
    const historico = {{ historico | tojson }};

    const labels = historico.map(item => `${item.mes_nome}/${item.ano}`);
    const faturamentoMeta = historico.map(item => item.meta_faturamento);
    const faturamentoReal = historico.map(item => item.faturamento_realizado);
    const atendimentosMeta = historico.map(item => item.meta_atendimentos);
    const atendimentosReal = historico.map(item => item.atendimentos_realizados);

    const ctxFat = document.getElementById('chartFaturamento').getContext('2d');
    new Chart(ctxFat, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Meta',
                data: faturamentoMeta,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                borderWidth: 2,
                tension: 0.4
            }, {
                label: 'Realizado',
                data: faturamentoReal,
                borderColor: 'rgba(40, 167, 69, 1)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 2,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                }
            }
        }
    });

    const ctxAtend = document.getElementById('chartAtendimentos').getContext('2d');
    new Chart(ctxAtend, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Meta',
                data: atendimentosMeta,
                backgroundColor: 'rgba(23, 162, 184, 0.5)',
                borderColor: 'rgba(23, 162, 184, 1)',
                borderWidth: 1
            }, {
                label: 'Realizado',
                data: atendimentosReal,
                backgroundColor: 'rgba(40, 167, 69, 0.5)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}
