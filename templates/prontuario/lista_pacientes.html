{% extends "base.html" %}

{% block title %}Lista de Pacientes - {{ config.CLINIC_NAME }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Cabeçalho da página -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-user-injured text-success me-2"></i>
                Lista de Pacientes
            </h2>
        </div>
    </div>
</div>

<!-- Formulário de busca -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="d-flex align-items-end gap-3">
                    <div class="flex-grow-1">
                        <label for="busca" class="form-label">
                            <i class="fas fa-search me-1"></i>
                            Buscar por Nome ou CPF
                        </label>
                        <input type="text" class="form-control" id="busca" name="busca" 
                               value="{{ busca }}" placeholder="Digite o nome ou CPF do paciente...">
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Buscar
                        </button>
                        {% if busca %}
                        <a href="{{ url_for('prontuario.lista_pacientes') }}" class="btn btn-secondary ms-1">
                            <i class="fas fa-times me-1"></i>Limpar
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="mb-2">
                    Total de pacientes: 
                    <span class="badge bg-success">{{ pacientes|length }}</span>
                </h6>
                {% if busca %}
                <small class="text-muted">Resultado da busca: "{{ busca }}"</small>
                {% else %}
                <small class="text-muted">Mostrando todos os pacientes</small>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Lista de pacientes -->
<div class="row">
    <div class="col-12">
        {% if pacientes %}
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Pacientes Cadastrados
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Contato</th>
                                <th>Cadastro</th>
                                <th>Atendimentos</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for paciente in pacientes %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ paciente.nome }}</strong>
                                        {% if paciente.data_nascimento %}
                                        <br>
                                        <small class="text-muted">
                                            Nascimento: {{ paciente.data_nascimento.strftime('%d/%m/%Y') }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <code>{{ paciente.cpf }}</code>
                                </td>
                                <td>
                                    {% if paciente.telefone %}
                                        <i class="fas fa-phone me-1 text-muted"></i>{{ paciente.telefone }}
                                        <br>
                                    {% endif %}
                                    {% if paciente.email %}
                                        <i class="fas fa-envelope me-1 text-muted"></i>{{ paciente.email }}
                                    {% endif %}
                                    {% if not paciente.telefone and not paciente.email %}
                                        <small class="text-muted">Sem contato</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ paciente.data_cadastro.strftime('%d/%m/%Y') }}
                                    </small>
                                </td>
                                <td>
                                    <span class="badge bg-primary">
                                        {{ paciente.prontuarios|length }} prontuários
                                    </span>
                                    <br>
                                    <span class="badge bg-info">
                                        {{ paciente.agendamentos|length }} agendamentos
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#modalPaciente{{ paciente.id }}">
                                            <i class="fas fa-eye me-1"></i>Ver Detalhes
                                        </button>
                                        <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarPaciente{{ paciente.id }}">
                                            <i class="fas fa-user-edit me-1"></i>Editar Dados
                                        </button>
                                        <a href="{{ url_for('prontuario.ver_prontuario', paciente_id=paciente.id) }}"
                                           class="btn btn-success btn-sm">
                                            <i class="fas fa-file-medical me-1"></i>Ver Prontuário
                                        </a>
                                        <a href="{{ url_for('agendamento.agendar') }}?paciente_id={{ paciente.id }}"
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-calendar-plus me-1"></i>Agendar
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modais de Detalhes dos Pacientes -->
        {% for paciente in pacientes %}
        <div class="modal fade" id="modalPaciente{{ paciente.id }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-user me-2"></i>Dados do Paciente
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <h4 class="text-primary">{{ paciente.nome }}</h4>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-id-card me-2 text-muted"></i>CPF:</strong>
                                <p class="ms-4">{{ paciente.cpf }}</p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-phone me-2 text-muted"></i>Telefone:</strong>
                                <p class="ms-4">{{ paciente.telefone or 'Não informado' }}</p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-envelope me-2 text-muted"></i>E-mail:</strong>
                                <p class="ms-4">{{ paciente.email or 'Não informado' }}</p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-birthday-cake me-2 text-muted"></i>Data de Nascimento:</strong>
                                <p class="ms-4">
                                    {% if paciente.data_nascimento %}
                                        {{ paciente.data_nascimento.strftime('%d/%m/%Y') }}
                                        {% if paciente.idade %}({{ paciente.idade }} anos){% endif %}
                                    {% else %}
                                        Não informado
                                    {% endif %}
                                </p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-map-marker-alt me-2 text-muted"></i>Naturalidade:</strong>
                                <p class="ms-4">{{ paciente.naturalidade or 'Não informado' }}</p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-heart me-2 text-muted"></i>Estado Civil:</strong>
                                <p class="ms-4">{{ paciente.estado_civil or 'Não informado' }}</p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-praying-hands me-2 text-muted"></i>Religião:</strong>
                                <p class="ms-4">{{ paciente.religiao or 'Não informado' }}</p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-briefcase me-2 text-muted"></i>Profissão:</strong>
                                <p class="ms-4">{{ paciente.profissao or 'Não informado' }}</p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-female me-2 text-muted"></i>Nome da Mãe:</strong>
                                <p class="ms-4">{{ paciente.filiacao_mae or 'Não informado' }}</p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-male me-2 text-muted"></i>Nome do Pai:</strong>
                                <p class="ms-4">{{ paciente.filiacao_pai or 'Não informado' }}</p>
                            </div>

                            <div class="col-12 mb-3">
                                <strong><i class="fas fa-home me-2 text-muted"></i>Endereço Completo:</strong>
                                <p class="ms-4">
                                    {% if paciente.endereco %}
                                        {{ paciente.endereco }}
                                        {% if paciente.bairro %}<br>Bairro: {{ paciente.bairro }}{% endif %}
                                        {% if paciente.cidade %}<br>Cidade: {{ paciente.cidade }}{% endif %}
                                    {% else %}
                                        Não informado
                                    {% endif %}
                                </p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <strong><i class="fas fa-calendar me-2 text-muted"></i>Cadastro:</strong>
                                <p class="ms-4">{{ paciente.data_cadastro.strftime('%d/%m/%Y às %H:%M') }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Edição do Paciente -->
        <div class="modal fade" id="modalEditarPaciente{{ paciente.id }}" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">
                            <i class="fas fa-user-edit me-2"></i>Editar Dados do Paciente
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="{{ url_for('prontuario.editar_paciente', paciente_id=paciente.id) }}">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="nome{{ paciente.id }}" class="form-label">Nome Completo *</label>
                                    <input type="text" class="form-control" id="nome{{ paciente.id }}"
                                           name="nome" value="{{ paciente.nome }}" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="cpf{{ paciente.id }}" class="form-label">CPF *</label>
                                    <input type="text" class="form-control" id="cpf{{ paciente.id }}"
                                           name="cpf" value="{{ paciente.cpf }}" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="telefone{{ paciente.id }}" class="form-label">Telefone *</label>
                                    <input type="text" class="form-control" id="telefone{{ paciente.id }}"
                                           name="telefone" value="{{ paciente.telefone or '' }}" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="email{{ paciente.id }}" class="form-label">E-mail</label>
                                    <input type="email" class="form-control" id="email{{ paciente.id }}"
                                           name="email" value="{{ paciente.email or '' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="data_nascimento{{ paciente.id }}" class="form-label">Data de Nascimento</label>
                                    <input type="date" class="form-control" id="data_nascimento{{ paciente.id }}"
                                           name="data_nascimento" value="{{ paciente.data_nascimento.strftime('%Y-%m-%d') if paciente.data_nascimento else '' }}">
                                </div>
                                <div class="col-md-5 mb-3">
                                    <label for="naturalidade{{ paciente.id }}" class="form-label">Naturalidade</label>
                                    <input type="text" class="form-control" id="naturalidade{{ paciente.id }}"
                                           name="naturalidade" value="{{ paciente.naturalidade or '' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="estado_civil{{ paciente.id }}" class="form-label">Estado Civil</label>
                                    <select class="form-select" id="estado_civil{{ paciente.id }}" name="estado_civil">
                                        <option value="">Selecione</option>
                                        <option value="Solteiro(a)" {{ 'selected' if paciente.estado_civil == 'Solteiro(a)' else '' }}>Solteiro(a)</option>
                                        <option value="Casado(a)" {{ 'selected' if paciente.estado_civil == 'Casado(a)' else '' }}>Casado(a)</option>
                                        <option value="Divorciado(a)" {{ 'selected' if paciente.estado_civil == 'Divorciado(a)' else '' }}>Divorciado(a)</option>
                                        <option value="Viúvo(a)" {{ 'selected' if paciente.estado_civil == 'Viúvo(a)' else '' }}>Viúvo(a)</option>
                                        <option value="União Estável" {{ 'selected' if paciente.estado_civil == 'União Estável' else '' }}>União Estável</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="religiao{{ paciente.id }}" class="form-label">Religião</label>
                                    <input type="text" class="form-control" id="religiao{{ paciente.id }}"
                                           name="religiao" value="{{ paciente.religiao or '' }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="profissao{{ paciente.id }}" class="form-label">Profissão</label>
                                    <input type="text" class="form-control" id="profissao{{ paciente.id }}"
                                           name="profissao" value="{{ paciente.profissao or '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="filiacao_mae{{ paciente.id }}" class="form-label">Nome da Mãe</label>
                                    <input type="text" class="form-control" id="filiacao_mae{{ paciente.id }}"
                                           name="filiacao_mae" value="{{ paciente.filiacao_mae or '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="filiacao_pai{{ paciente.id }}" class="form-label">Nome do Pai</label>
                                    <input type="text" class="form-control" id="filiacao_pai{{ paciente.id }}"
                                           name="filiacao_pai" value="{{ paciente.filiacao_pai or '' }}">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label for="endereco{{ paciente.id }}" class="form-label">Endereço</label>
                                    <input type="text" class="form-control" id="endereco{{ paciente.id }}"
                                           name="endereco" value="{{ paciente.endereco or '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="bairro{{ paciente.id }}" class="form-label">Bairro</label>
                                    <input type="text" class="form-control" id="bairro{{ paciente.id }}"
                                           name="bairro" value="{{ paciente.bairro or '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cidade{{ paciente.id }}" class="form-label">Cidade</label>
                                    <input type="text" class="form-control" id="cidade{{ paciente.id }}"
                                           name="cidade" value="{{ paciente.cidade or '' }}">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save me-1"></i>Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <!-- Mensagem quando não há pacientes -->
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-user-times fa-4x text-muted mb-3"></i>
                {% if busca %}
                <h4 class="text-muted">Nenhum paciente encontrado</h4>
                <p class="text-muted mb-4">
                    Não foram encontrados pacientes com o termo: <strong>"{{ busca }}"</strong>
                </p>
                <a href="{{ url_for('prontuario.lista_pacientes') }}" class="btn btn-secondary me-2">
                    <i class="fas fa-arrow-left me-1"></i>Ver Todos
                </a>
                {% else %}
                <h4 class="text-muted">Nenhum paciente cadastrado</h4>
                <p class="text-muted mb-4">
                    Ainda não há pacientes cadastrados no sistema.
                    O primeiro paciente será cadastrado automaticamente ao criar um agendamento.
                </p>
                {% endif %}
                <a href="{{ url_for('agendamento.agendar') }}" class="btn btn-primary">
                    <i class="fas fa-calendar-plus me-1"></i>Criar Agendamento
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Cards com estatísticas rápidas -->
{% if pacientes %}
<div class="row mt-4">
    <div class="col-12">
        <h4 class="mb-3">
            <i class="fas fa-chart-bar me-2"></i>
            Estatísticas Rápidas
        </h4>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total de Pacientes</h6>
                        <h4>{{ pacientes|length }}</h4>
                    </div>
                    <i class="fas fa-users fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Com Prontuários</h6>
                        <h4>{{ pacientes|selectattr('prontuarios')|list|length }}</h4>
                    </div>
                    <i class="fas fa-file-medical fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Com Telefone</h6>
                        <h4>{{ pacientes|selectattr('telefone')|list|length }}</h4>
                    </div>
                    <i class="fas fa-phone fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Cadastros Recentes</h6>
                        <h4>{{ pacientes|selectattr('data_cadastro')|list|length if pacientes else 0 }}</h4>
                    </div>
                    <i class="fas fa-calendar-plus fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}